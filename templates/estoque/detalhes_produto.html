{% extends 'base.html' %}
{% load humanize %}

{% block page_title %}{{ produto.nome }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-box"></i> {{ produto.nome }}
                </h5>
                <div>
                    <a href="{% url 'estoque:editar_produto' produto.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i> Editar
                    </a>
                    <a href="{% url 'estoque:movimentacao_estoque' %}?produto={{ produto.id }}" class="btn btn-sm btn-success">
                        <i class="bi bi-arrow-left-right"></i> Movimentar
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informações Básicas</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Código:</strong></td>
                                <td>{{ produto.codigo }}</td>
                            </tr>
                            <tr>
                                <td><strong>Nome:</strong></td>
                                <td>{{ produto.nome }}</td>
                            </tr>
                            <tr>
                                <td><strong>Categoria:</strong></td>
                                <td>{{ produto.categoria.nome }}</td>
                            </tr>
                            <tr>
                                <td><strong>Fornecedor:</strong></td>
                                <td>{{ produto.fornecedor.nome }}</td>
                            </tr>
                            <tr>
                                <td><strong>Unidade:</strong></td>
                                <td>{{ produto.get_unidade_display }}</td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td>
                                    {% if produto.ativo %}
                                        <span class="badge bg-success">Ativo</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inativo</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Preços e Estoque</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Preço de Custo:</strong></td>
                                <td>R$ {{ produto.preco_custo|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <td><strong>Preço de Venda:</strong></td>
                                <td>R$ {{ produto.preco_venda|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <td><strong>Margem de Lucro:</strong></td>
                                <td>{{ produto.margem_lucro|floatformat:2 }}%</td>
                            </tr>
                            <tr>
                                <td><strong>Estoque Atual:</strong></td>
                                <td>
                                    <span class="badge bg-{% if produto.estoque_atual <= 0 %}danger{% elif produto.estoque_atual <= produto.estoque_minimo %}warning{% else %}success{% endif %}">
                                        {{ produto.estoque_atual }} {{ produto.get_unidade_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Estoque Mínimo:</strong></td>
                                <td>{{ produto.estoque_minimo|default:"Não definido" }} {{ produto.get_unidade_display }}</td>
                            </tr>
                            <tr>
                                <td><strong>Valor Total:</strong></td>
                                <td>R$ {{ produto.valor_total_estoque|floatformat:2 }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                {% if produto.descricao %}
                <div class="mt-3">
                    <h6>Descrição</h6>
                    <p class="text-muted">{{ produto.descricao }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Status do Estoque -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">Status do Estoque</h6>
            </div>
            <div class="card-body text-center">
                {% if produto.status_estoque == "Sem Estoque" %}
                    <i class="bi bi-exclamation-triangle-fill text-danger display-4"></i>
                    <h4 class="text-danger mt-2">{{ produto.status_estoque }}</h4>
                {% elif produto.status_estoque == "Estoque Baixo" %}
                    <i class="bi bi-exclamation-triangle-fill text-warning display-4"></i>
                    <h4 class="text-warning mt-2">{{ produto.status_estoque }}</h4>
                {% else %}
                    <i class="bi bi-check-circle-fill text-success display-4"></i>
                    <h4 class="text-success mt-2">{{ produto.status_estoque }}</h4>
                {% endif %}
            </div>
        </div>
        
        <!-- Informações de Cadastro -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Informações de Cadastro</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Data de Cadastro:</strong></td>
                        <td>{{ produto.data_cadastro|date:"d/m/Y H:i" }}</td>
                    </tr>
                    <tr>
                        <td><strong>Última Atualização:</strong></td>
                        <td>{{ produto.data_atualizacao|date:"d/m/Y H:i" }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Histórico de Movimentações -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-clock-history"></i> Histórico de Movimentações
                </h6>
            </div>
            <div class="card-body">
                {% if movimentacoes %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Quantidade</th>
                                    <th>Usuário</th>
                                    <th>Observações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mov in movimentacoes %}
                                <tr>
                                    <td>{{ mov.data_movimentacao|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        <span class="badge bg-{% if mov.tipo == 'ENTRADA' %}success{% elif mov.tipo == 'SAIDA' %}danger{% else %}info{% endif %}">
                                            {{ mov.get_tipo_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if mov.tipo == 'ENTRADA' %}
                                            <span class="text-success">+{{ mov.quantidade }}</span>
                                        {% elif mov.tipo == 'SAIDA' %}
                                            <span class="text-danger">-{{ mov.quantidade }}</span>
                                        {% else %}
                                            <span class="text-info">{{ mov.quantidade }}</span>
                                        {% endif %}
                                        {{ produto.get_unidade_display }}
                                    </td>
                                    <td>{{ mov.usuario.first_name|default:mov.usuario.username }}</td>
                                    <td>{{ mov.observacoes|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">Nenhuma movimentação registrada para este produto.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <a href="{% url 'estoque:lista_produtos' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Voltar para Lista
        </a>
    </div>
</div>
{% endblock %}
