{% extends 'base.html' %}

{% block page_title %}Exportar Relat√≥rios{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">üìä Exportar Relat√≥rios</h2>
                <p class="text-muted mb-0">Exporte dados do sistema para Excel com filtro de datas</p>
            </div>
            <div>
                <a href="{% url 'estoque:relatorios' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar aos Relat√≥rios
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-download"></i> Configura√ß√£o da Exporta√ß√£o
                </h6>
            </div>
            <div class="card-body">
                <form method="post" id="exportForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.data_inicio.id_for_label }}" class="form-label">
                                <i class="bi bi-calendar-event"></i> {{ form.data_inicio.label }}
                            </label>
                            {{ form.data_inicio }}
                            {% if form.data_inicio.help_text %}
                                <div class="form-text">{{ form.data_inicio.help_text }}</div>
                            {% endif %}
                            {% if form.data_inicio.errors %}
                                <div class="text-danger">
                                    {% for error in form.data_inicio.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.data_fim.id_for_label }}" class="form-label">
                                <i class="bi bi-calendar-check"></i> {{ form.data_fim.label }}
                            </label>
                            {{ form.data_fim }}
                            {% if form.data_fim.help_text %}
                                <div class="form-text">{{ form.data_fim.help_text }}</div>
                            {% endif %}
                            {% if form.data_fim.errors %}
                                <div class="text-danger">
                                    {% for error in form.data_fim.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.tipo_relatorio.id_for_label }}" class="form-label">
                            <i class="bi bi-file-earmark-spreadsheet"></i> {{ form.tipo_relatorio.label }}
                        </label>
                        {{ form.tipo_relatorio }}
                        {% if form.tipo_relatorio.help_text %}
                            <div class="form-text">{{ form.tipo_relatorio.help_text }}</div>
                        {% endif %}
                        {% if form.tipo_relatorio.errors %}
                            <div class="text-danger">
                                {% for error in form.tipo_relatorio.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary me-md-2" onclick="limparFormulario()">
                            <i class="bi bi-arrow-clockwise"></i> Limpar
                        </button>
                        <button type="submit" class="btn btn-primary" id="exportBtn">
                            <i class="bi bi-download"></i> Exportar para Excel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Informa√ß√µes sobre os tipos de relat√≥rio -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-info">
                    <i class="bi bi-info-circle"></i> Tipos de Relat√≥rios Dispon√≠veis
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0">
                                <i class="bi bi-arrow-left-right text-primary fs-4"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">Movimenta√ß√µes de Estoque</h6>
                                <p class="text-muted mb-0 small">
                                    Exporta todas as movimenta√ß√µes (entradas e sa√≠das) do per√≠odo selecionado, 
                                    incluindo data, produto, categoria, tipo, quantidade, usu√°rio e observa√ß√µes.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0">
                                <i class="bi bi-box text-success fs-4"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">Produtos</h6>
                                <p class="text-muted mb-0 small">
                                    Exporta lista completa de produtos com informa√ß√µes de estoque, 
                                    pre√ßos, categorias, fornecedores e status atual.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0">
                                <i class="bi bi-cart text-warning fs-4"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">Vendas</h6>
                                <p class="text-muted mb-0 small">
                                    Exporta vendas realizadas no per√≠odo selecionado, 
                                    incluindo data, cliente, total, status e vendedor.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0">
                                <i class="bi bi-graph-up text-info fs-4"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">Resumo Geral</h6>
                                <p class="text-muted mb-0 small">
                                    Exporta resumo estat√≠stico do per√≠odo com m√©tricas de estoque, 
                                    movimenta√ß√µes e indicadores gerais do sistema.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dicas de uso -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h6 class="alert-heading">
                <i class="bi bi-lightbulb"></i> Dicas para Exporta√ß√£o
            </h6>
            <ul class="mb-0">
                <li><strong>Intervalo de datas:</strong> Selecione um per√≠odo de no m√°ximo 1 ano para melhor performance</li>
                <li><strong>Formato do arquivo:</strong> Os relat√≥rios s√£o exportados em formato Excel (.xlsx)</li>
                <li><strong>Nome do arquivo:</strong> O arquivo ser√° nomeado automaticamente com o tipo de relat√≥rio e per√≠odo</li>
                <li><strong>Dados em tempo real:</strong> Os relat√≥rios sempre refletem os dados mais atuais do sistema</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Definir data padr√£o (√∫ltimos 30 dias)
    const hoje = new Date();
    const trintaDiasAtras = new Date();
    trintaDiasAtras.setDate(hoje.getDate() - 30);
    
    // Formatar datas para input type="date"
    const formatarData = (data) => {
        return data.toISOString().split('T')[0];
    };
    
    // Definir valores padr√£o se os campos estiverem vazios
    const dataInicio = document.getElementById('data-inicio');
    const dataFim = document.getElementById('data-fim');
    
    if (!dataInicio.value) {
        dataInicio.value = formatarData(trintaDiasAtras);
    }
    if (!dataFim.value) {
        dataFim.value = formatarData(hoje);
    }
    
    // Valida√ß√£o em tempo real
    const form = document.getElementById('exportForm');
    const exportBtn = document.getElementById('exportBtn');
    
    form.addEventListener('submit', function(e) {
        const dataInicioValue = new Date(dataInicio.value);
        const dataFimValue = new Date(dataFim.value);
        
        if (dataInicioValue > dataFimValue) {
            e.preventDefault();
            alert('A data de in√≠cio deve ser anterior √† data de fim.');
            return;
        }
        
        // Mostrar loading no bot√£o
        exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Exportando...';
        exportBtn.disabled = true;
    });
    
    // Valida√ß√£o de intervalo m√°ximo (1 ano)
    function validarIntervalo() {
        const dataInicioValue = new Date(dataInicio.value);
        const dataFimValue = new Date(dataFim.value);
        const diffTime = Math.abs(dataFimValue - dataInicioValue);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays > 365) {
            alert('O intervalo de datas n√£o pode ser maior que 1 ano.');
            dataFim.value = formatarData(new Date(dataInicioValue.getTime() + (365 * 24 * 60 * 60 * 1000)));
        }
    }
    
    dataInicio.addEventListener('change', validarIntervalo);
    dataFim.addEventListener('change', validarIntervalo);
});

function limparFormulario() {
    document.getElementById('exportForm').reset();
    
    // Redefinir valores padr√£o
    const hoje = new Date();
    const trintaDiasAtras = new Date();
    trintaDiasAtras.setDate(hoje.getDate() - 30);
    
    document.getElementById('data-inicio').value = trintaDiasAtras.toISOString().split('T')[0];
    document.getElementById('data-fim').value = hoje.toISOString().split('T')[0];
    
    // Reabilitar bot√£o
    const exportBtn = document.getElementById('exportBtn');
    exportBtn.innerHTML = '<i class="bi bi-download"></i> Exportar para Excel';
    exportBtn.disabled = false;
}

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl + Enter para exportar
    if (e.ctrlKey && e.key === 'Enter') {
        document.getElementById('exportForm').submit();
    }
    
    // Escape para limpar
    if (e.key === 'Escape') {
        limparFormulario();
    }
});
</script>
{% endblock %}

